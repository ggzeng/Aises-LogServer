<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket è°ƒè¯• - æŸ¥çœ‹ client_id</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #252526;
            border-radius: 8px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            font-size: 12px;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>WebSocket è°ƒè¯•å·¥å…·</h1>

    <div class="section">
        <h3>1. æµ‹è¯• WebSocket è¿æ¥</h3>
        <div id="wsStatus">æœªè¿æ¥</div>
        <button onclick="testWebSocket()">è¿æ¥ WebSocket</button>
    </div>

    <div class="section">
        <h3>2. æŸ¥çœ‹æ¥æ”¶åˆ°çš„æ¶ˆæ¯</h3>
        <div id="messageLog"></div>
    </div>

    <div class="section">
        <h3>3. æµ‹è¯•å®¢æˆ·ç«¯çŠ¶æ€</h3>
        <div id="clientInfo"></div>
    </div>

    <div class="section">
        <h3>4. å‘é€æµ‹è¯•æ—¥å¿—</h3>
        <button onclick="sendTestLog()">å‘é€æµ‹è¯•æ—¥å¿—</button>
    </div>

    <script>
        let ws = null;
        let messageCount = 0;

        function log(msg, type = 'info') {
            const logDiv = document.getElementById('messageLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logDiv.insertBefore(entry, logDiv.firstChild);

            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        function updateWsStatus(status, color) {
            document.getElementById('wsStatus').textContent = status;
            document.getElementById('wsStatus').style.color = color;
        }

        function testWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            log(`è¿æ¥åˆ°: ${wsUrl}`, 'info');

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    log('âœ“ WebSocket å·²è¿æ¥', 'success');
                    updateWsStatus('å·²è¿æ¥', '#4ec9b0');

                    // è¯·æ±‚å®¢æˆ·ç«¯åˆ—è¡¨
                    ws.send(JSON.stringify({ type: 'get_clients' }));
                };

                ws.onmessage = (event) => {
                    messageCount++;
                    log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ #${messageCount}`, 'info');

                    try {
                        const data = JSON.parse(event.data);
                        log(`æ¶ˆæ¯ç±»å‹: ${data.type}`, 'info');
                        log(`å®Œæ•´æ¶ˆæ¯: ${JSON.stringify(data, null, 2)}`, 'info');

                        // æ£€æŸ¥ client_id å­—æ®µ
                        if (data.client_id) {
                            log(`âœ“ client_id å­—æ®µå­˜åœ¨: ${data.client_id}`, 'success');
                            document.getElementById('clientInfo').innerHTML =
                                `å½“å‰æ¥æ”¶åˆ°çš„ client_id: <strong>${data.client_id}</strong>`;
                        } else {
                            log('âœ— æ¶ˆæ¯ä¸­æ²¡æœ‰ client_id å­—æ®µ', 'warning');
                        }

                        // æ£€æŸ¥ data.data ä¸­æ˜¯å¦æœ‰ client_id
                        if (data.data && data.data.client_id) {
                            log(`âœ“ data.client_id å­˜åœ¨: ${data.data.client_id}`, 'success');
                        }
                    } catch (e) {
                        log(`âœ— è§£ææ¶ˆæ¯å¤±è´¥: ${e}`, 'error');
                    }
                };

                ws.onerror = (error) => {
                    log('âœ— WebSocket é”™è¯¯', 'error');
                    updateWsStatus('è¿æ¥é”™è¯¯', '#f48771');
                };

                ws.onclose = (event) => {
                    log(`âœ— WebSocket è¿æ¥å…³é—­ (code: ${event.code})`, 'error');
                    updateWsStatus('å·²å…³é—­', '#f48771');
                };

            } catch (error) {
                log(`âœ— åˆ›å»º WebSocket å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function sendTestLog() {
            const logData = {
                clientId: "debug-test",
                hostname: "debug-host",
                timestamp: "2026-01-20 17:30:00.000",
                messages: [{
                    timestamp: "2026-01-20 17:30:00.000",
                    level: "INFO",
                    message: "è°ƒè¯•æµ‹è¯•æ¶ˆæ¯ï¼ŒåŒ…å«æ•°å­— 88888",
                    logger: "debug",
                    function: "test",
                    line: 1
                }]
            };

            log('å‘é€æµ‹è¯•æ—¥å¿—...', 'info');
            log(`è¯·æ±‚æ•°æ®: ${JSON.stringify(logData, null, 2)}`, 'info');

            try {
                const response = await fetch('/logs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`âœ“ æ—¥å¿—å·²å‘é€: ${result.message}`, 'success');
                } else {
                    log(`âœ— å‘é€å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âœ— å‘é€å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„æ£€æŸ¥
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ', 'info');

            // æ£€æŸ¥ API
            fetch('/api/config')
                .then(res => res.json())
                .then(config => {
                    log('âœ“ API å¯ç”¨', 'success');
                    log(`é…ç½®: max_logs_per_client=${config.max_logs_per_client}`, 'info');
                })
                .catch(err => {
                    log('âœ— API ä¸å¯ç”¨', 'error');
                });
        });
    </script>
</body>
</html>
